---
show: step
version: 1.0
enable_checker: true
---

# å°è£…æ•°æ®åº“è¿æ¥

### å›å¿†
- è¿™æ¬¡äºŒæ¬¡ç¡®è®¤äº†å¯†ç 
- å¹¶ä¸”ç¡®è®¤å¯†ç 
	- å¿…é¡»å¾—æœ‰å¤§å†™å°å­—å’Œæ•°å­—
	- 8-16ä¸ªå­—ç¬¦
- è¿™æ ·æ’å…¥ç”¨æˆ·åå¯†ç éƒ½æ¯”è¾ƒè§„èŒƒäº†
- InsertServletå’ŒSelectServletéƒ½éœ€è¦è¿æ¥æ•°æ®åº“
	- å¦‚æœæ•°æ®åº“æ”¹å¯†ç éœ€è¦æ”¹ä¸¤ä¸ªæ–‡ä»¶
	- èƒ½å¦æŠŠæ•°æ®åº“è¿æ¥å°è£…ä¸€ä¸‹
	- è¿™æ ·å°±æ”¹æ•°æ®åº“ç”¨æˆ·åå¯†ç å°±å®¹æ˜“å¤šäº†
	- æ€ä¹ˆæ”¹å‘¢?ğŸ¤”

### æœç´¢

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651064504497)

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651064653696)

### ä¾‹ç¨‹

```java
 
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
 
	public class DBConUtil {
		private static final String URL = "jdbc:mysql://æœåŠ¡å™¨åœ°å€(å¦‚ï¼šlocalhost):ç«¯å£(å¦‚ï¼š3306)/æ•°æ®åº“åç§°?userServerPrepStmts=true&cachePrepStmts=true";
		private static final String USER = "æ•°æ®åº“ç”¨æˆ·å(å¦‚ï¼šroot)";
		private static final String PASSWORD = "æ•°æ®åº“å¯†ç ";
		private static final String DRIVERPATH = "com.mysql.jdbc.Driver";
		private static Connection conn = null;
		static {
			try {
				Class.forName(DRIVERPATH);
			} catch (ClassNotFoundException e) {
				e.printStackTrace();
			}
	}
 
	public static Connection getConn() {
		// å¤„ç†çº¿ç¨‹å®‰å…¨é—®é¢˜
		synchronized (DBConUtil.class) {
			try {
				// å¦‚æœconnä¸ºnullæˆ–è€…connå·²å…³é—­å¾—æ—¶å€™ï¼Œéœ€è¦é‡æ–°åˆ›å»ºconnå¯¹è±¡
				if (null == conn || conn.isClosed()) {
					synchronized (DBConUtil.class) {
						conn = DriverManager.getConnection(URL, USER, PASSWORD);
					}
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
 
		return conn;
	}
 
	public static void close(Connection conn, PreparedStatement pstm, Statement stmt, ResultSet rs) {
		if (null != rs) {
			try {
				rs.close();
			} catch (SQLException e) {
				e.printStackTrace();
			} finally {
				if (null != stmt) {
					try {
						stmt.close();
					} catch (SQLException e) {
						e.printStackTrace();
					} finally {
						if (null != pstm) {
							try {
								pstm.close();
							} catch (SQLException e) {
								e.printStackTrace();
							} finally {
								if (null != conn) {
									try {
										conn.close();
									} catch (SQLException e) {
										e.printStackTrace();
									}
								}
							}
						}
					}
				}
			}
		}
	}
}
```
- DBConUtil
	- DBå°±æ˜¯æ•°æ®åº“database
	- Conå°±æ˜¯æ•°æ®åº“è¿æ¥Connection
	- Utilå°±æ˜¯åº”ç”¨(å®ç”¨ç¨‹åº)utility
- è¿™ä¸ªé‡Šæ”¾çš„è¿‡ç¨‹å¾ˆå¤æ‚
- ä»–ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™å‘¢ï¼Ÿ

### åŸå› 

- å› ä¸ºå¦‚æœä½ ä¸è¿™ä¹ˆå†™çš„è¯
- å°±ä¼šé€ æˆå†…å­˜çš„æ³„éœ²
- æœ€åå¯¼è‡´æœåŠ¡å™¨çš„å´©æºƒ


![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220616-1655337493066/wm)

- é‚£ä»–ä¸ºä»€ä¹ˆä¼šå¼•èµ·å†…å­˜çš„æ³„æ¼å‘¢ï¼Ÿ

### åŸå§‹ä»£ç 

```
try {
    Class.forName("org.postgresql.Driver");
    c = DriverManager.getConnection(
            "jdbc:postgresql://localhost:5432/oeasy", "postgres",
            "oeasy@pg");
    c.setAutoCommit(false);

    out.println("connection is ok<br/>");
    stmt = c.createStatement();

    ResultSet rs = stmt.executeQuery("select * from urls where topic like 's%'");
    while(rs.next()){
        String topic = rs.getString("topic");
        String url = rs.getString("url");
        out.print(topic+":"+url+"<br/>");
    }
    rs.close();
    stmt.close();
    c.close();

} catch (Exception e) {
    e.printStackTrace();
    System.err.println(e.getClass().getName() + ": " + e.getMessage());
}
```

- å¦‚æœrs.close()å‡ºäº†é—®é¢˜
- ç›´æ¥è·³è½¬åˆ°catchçš„éƒ¨åˆ†
- stmtå’Œcéƒ½æ— æ³•é‡Šæ”¾
- ä¹…è€Œä¹…ä¹‹éƒ½éœ€è¦å ç”¨å†…å­˜
- å¯¼è‡´ç³»ç»Ÿæœ€ç»ˆå´©æºƒ
- é‚£æ–°ä»£ç åˆæ˜¯å¦‚ä½•è§£å†³å†…å­˜æ³„æ¼é—®é¢˜çš„å‘¢?

### æ–°ä»£ç  
```
if (null != rs) {
    try {
        rs.close();
    } catch (SQLException e) {
        e.printStackTrace();
    } finally {
        if (null != stmt) {
            try {
                stmt.close();
            } catch (SQLException e) {
                e.printStackTrace();
            } finally {
                if (null != pstm) {
                    try {
                        pstm.close();
                    } catch (SQLException e) {
                        e.printStackTrace();
                    } finally {
                        if (null != conn) {
                            try {
                                conn.close();
                            } catch (SQLException e) {
                                e.printStackTrace();
                            }
                        }
                    }
                }
            }
        }
    }
}
```

- æµç¨‹æ˜¯è¿™æ ·çš„
	- é¦–å…ˆåˆ¤æ–­rsæ˜¯å¦ä¸ºç©º
	- å¦‚æœrsä¸ä¸ºç©º
	- å°è¯•å…³é—­
	- æ— è®ºrs.close()æ˜¯å¦æˆåŠŸ
	- éƒ½ä¼šè¿›å…¥åˆ°finally
	- ç„¶åç»§ç»­é‡Šæ”¾stmt
	- æ— è®ºstmt.close()æ˜¯å¦æˆåŠŸ
	- éƒ½ä¼šè¿›å…¥åˆ°finally
	- éƒ½ä¼šé‡Šæ”¾connection
- æ•´ä½“ç›®æ ‡å°±æ˜¯å¯¹æ•°æ®åº“è¿æ¥çš„å°è£…
	- å¦‚ä½•ç†è§£å¯¹äºConnectionçš„å°è£…å‘¢ï¼Ÿ
	- é‚£å…·ä½“è¿˜æœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ

### åŸå§‹ä»£ç 

- åŸæ¥é€šè¿‡Managerç›´æ¥getåˆ°ä¸€ä¸ªConnection
- ç„¶åæ ¹æ®è¿™ä¸ªConnectionå†™è¯­å¥
- æ‰§è¡ŒæŸ¥è¯¢å’Œæ›´æ–°æ“ä½œ
- æ¯æ¬¡æ¥åˆ°ä¸€ä¸ªè¯·æ±‚å°±è¦åŠ¨æ€åˆ†é…ä¸€ä¸ªåœ°å€
- ç„¶åæœ€ç»ˆçš„æ—¶å€™é‡Šæ”¾

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651065001552)

- æ–°ä»£ç æœ‰ä»€ä¹ˆå¥½çš„å‘¢ï¼Ÿ

### é™æ€æ–¹æ³•

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651065513727)

- é™æ€æ–¹æ³•
- ä¸ç”¨æ¯ä¸ªéƒ½æ–°å»ºä¸€ä¸ªå¯¹è±¡
- åªè¦æœ‰ç±»å°±å¯ä»¥ä½¿ç”¨æ–¹æ³•
- ä¸éœ€è¦å¯¹è±¡ä¹Ÿå°±èŠ‚çœäº†å†…å­˜

### å°è¯•

- æŠŠå‚æ•°æ”¹æˆæˆ‘ä»¬çš„ç”¨æˆ·åå¯†ç 

```java
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

public class DBConUtil {
	private static final String URL = "jdbc:postgresql://localhost:5432/oeasy";
	private static final String USER = "postgres";
	private static final String PASSWORD = "oeasy@pg";
	private static final String DRIVERPATH = "org.postgresql.Driver";
	private static Connection conn = null;
	static {
		try {
			Class.forName(DRIVERPATH);
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}
	}

	public static Connection getConn() {
		synchronized (DBConUtil.class) {
			try {
				if (null == conn || conn.isClosed()) {
					synchronized (DBConUtil.class) {
						conn = DriverManager.getConnection(URL, USER, PASSWORD);
					}
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
		}

		return conn;
	}

	public static void close(Connection conn, PreparedStatement pstm, Statement stmt, ResultSet rs) {
		if (null != rs) {
			try {
				rs.close();
			} catch (SQLException e) {
				e.printStackTrace();
			} finally {
				if (null != stmt) {
					try {
						stmt.close();
					} catch (SQLException e) {
						e.printStackTrace();
					} finally {
						if (null != pstm) {
							try {
								pstm.close();
							} catch (SQLException e) {
								e.printStackTrace();
							} finally {
								if (null != conn) {
									try {
										conn.close();
									} catch (SQLException e) {
										e.printStackTrace();
									}
								}
							}
						}
					}
				}
			}
		}
	}
}

```

- ä¿å­˜å¹¶ä¸”ç¼–è¯‘é€šè¿‡
- ç°åœ¨éœ€è¦æ”¹é€ SelectServlet.java

### SelectServlet
```java
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.io.IOException;
import java.io.PrintWriter;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
public class SelectServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    @Override
    public void doGet(HttpServletRequest request,
                      HttpServletResponse response)
        throws IOException, ServletException
    {
		DBConUtil dbu = new DBConUtil();
        response.setContentType("text/html");
        response.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();
        out.println("<!DOCTYPE html><html><body>");
        Connection c = null;
        Statement stmt = null;
        try {
            c = dbu.getConn();
            c.setAutoCommit(false);

            out.println("connection is ok<br/>");
            stmt = c.createStatement();

            ResultSet rs = stmt.executeQuery("select * from login");
            while(rs.next()){
                String username = rs.getString("username");
                String password = rs.getString("password");
                out.print(username+"::"+password+"<br/>");
            }
			dbu.close(c,null,stmt,rs);
        } catch (Exception e) {
            e.printStackTrace();
            System.err.println(e.getClass().getName() + ": " + e.getMessage());
        }
        out.println("select query is ok!<br/>");
        out.println("</body></html>");
    }
}

```

### åˆ†æå˜åŒ–
![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651067912214)

- æ‰§è¡ŒæˆåŠŸï¼
	- ä»£ç æ˜¾å¾—ç®€å•äº†
	- è€Œä¸”å¦‚æœä¿®æ”¹æ•°æ®åº“ç”¨æˆ·åå¯†ç 
	- åªéœ€è¦ä¿®æ”¹DBConnUtilå°±å¯ä»¥

- é™æ€æ–¹æ³•ä¸ç”¨newå¯¹è±¡

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651068310586)

- å†å»ä¿®æ”¹InsertServlet

### InsertServlet

```java
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.io.IOException;
import java.io.PrintWriter;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
public class InsertServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    @Override
    public void doPost(HttpServletRequest request,
            HttpServletResponse response)
        throws IOException, ServletException{
        request.setCharacterEncoding("utf-8");
        response.setContentType("text/html");
        response.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();
        Connection c = null;
        Statement stmt = null;
        try {
            c = DBConUtil.getConn();
            c.setAutoCommit(false);
            out.println("db connection is ok!!<br/>");
            stmt = c.createStatement();
            String Username = request.getParameter("username");
            String Password = request.getParameter("password");
            if(Username!=null&&Username.length()>10){
                System.out.println("=====yes username too loog");
                DBConUtil.close(c,null,stmt,null);
                response.sendRedirect("http://localhost:8080/oeasy/error?msg=usernameTooLong");
            }
            else{
                ResultSet rs = stmt.executeQuery("select * from login where Username='"+Username+"'");
                if(rs.next()){
                    DBConUtil.close(c,null,stmt,rs);
                    response.sendRedirect("http://localhost:8080/oeasy/error?msg=usernameExists");
                }
                else{
                    String sql = "insert into login(username,password) values('"+Username+"','"+Password+"');";
                    System.out.print("sql======================" + sql);
                    stmt.executeUpdate(sql);
                    DBConUtil.close(c,null,stmt,rs);
                    response.sendRedirect("http://localhost:8080/oeasy/select");
                }

            }
        } catch (Exception e) {
            e.printStackTrace();
            System.err.println(e.getClass().getName() + ": " + e.getMessage());
            response.sendRedirect("http://localhost:8080/oeasy/error?msg=err");
        }
    }
}
```

### ç»“æœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651068809681)

- æˆåŠŸæ’å…¥æ•°æ®

### æ€»ç»“
- è¿™æ¬¡æŠŠæ•°æ®åº“ç»™å°è£…äº†ä¸€å±‚
	- æ–°å»ºäº†ä¸€ä¸ªç±»DBConUtil 
- å¥½å¤„æ˜¯
	- è¾ƒå°‘ä»£ç é‡
	- æ›¿æ¢æ•°æ®åº“ç”¨æˆ·åå¯†ç å˜å¾—å¾ˆæ–¹ä¾¿
- è¿™ä¸ªç±»é‡Œé¢æåˆ°çš„
	- Connã€Statementã€ResultSetéƒ½è§è¿‡
	- PrepareStatementç©¶ç«Ÿæ˜¯ä»€ä¹ˆ?
	- æ€ä¹ˆç”¨å‘¢ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ï¼ğŸ‘‹