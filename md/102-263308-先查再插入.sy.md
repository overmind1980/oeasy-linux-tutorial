---
show: step
version: 1.0
enable_checker: true
---

# å…ˆæŸ¥è¯¢å†æ’å…¥

### å›å¿†
- ä¸Šæ¬¡ç ”ç©¶äº†è¡¨å•æäº¤ä¿¡æ¯çš„å…¥åº“
	- å°±æ˜¯ä¸€ä¸ªæ³¨å†Œçš„è¿‡ç¨‹
	- æˆ‘ä»¬æ•´åˆäº†æ¥æ”¶postè¿‡æ¥çš„æ•°æ®å’Œæ’å…¥æ•°æ®åº“çš„ä»£ç 
	- å°†æ¥æ”¶åˆ°çš„è¡¨å•æ•°æ®ç›´æ¥æ’å…¥æ•°æ®åº“
- ä½†æ˜¯å¦‚æœå·²ç»æœ‰äº†çš„ç”¨æˆ·å
	- é‡æ–°æäº¤ä¼šå¦‚ä½•å‘¢ï¼Ÿï¼ŸğŸ¤”

### æˆ‘ä»¬æ¥è¯•è¯•

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20211130-1638240643710)

- å·²ç»æœ‰äº†aaa
- æˆ‘ä»¬è¿˜è¦æ’å…¥aaa
- ç»“æœè‚¯å®šæ˜¯æ— æ³•é‡å¤æ’å…¥çš„

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20211130-1638240830697)

- è€Œä¸”è¿”å›äº†ä¸€ä¸ªç™½å±
- é‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

### çœ‹æ—¥å¿—

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651026539716)

- è¿™å¥sqlè¯­å¥æ˜¯å¯ä»¥çœ‹åˆ°çš„
- æ’å…¥ä¹‹åè¿”å›çš„é”™è¯¯ä¹Ÿæ˜¯å¯çœ‹åˆ°çš„
	- ä¸»è¦æ˜¯è¿åäº†usernameçš„uniqueçº¦æŸ
	- æœ¬æ¥æœ‰ä¸ª'aaa'çš„ç”¨æˆ·å
	- æˆ‘æƒ³è¦å†æ’ä¸€ä¸ª'aaa'çš„ç”¨æˆ·å
- æˆ‘ä»¬å¯ä»¥ç›´æ¥å»psqlé‡Œé¢è¯•è¯•è¿™å¥è¯

### é‡å¤æ’å…¥

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20211130-1638241035226)

- æŠ¥çš„é”™è¯¯æ˜¯ä¸€æ ·çš„
- å› ä¸ºè¿™ç§uniqueçº¦æŸçš„å­˜åœ¨
	- åŒæ ·çš„ç”¨æˆ·åæ˜¯ä¸èƒ½é‡å¤æ’å…¥çš„
	- ä½†æ˜¯è¿™ç§è¿”å›ç™½å±æ˜¯å¾ˆå®¹æ˜“è®©ç”¨æˆ·å›°æƒ‘çš„
- æˆ‘ä»¬åº”è¯¥æ˜ç¡®åœ°å‘Šè¯‰ç”¨æˆ·
	- è¿™ä¸ªç”¨æˆ·åå·²ç»å­˜åœ¨
	- è¯·æ¢ä¸€ä¸ªç”¨æˆ·å
	- è€Œä¸æ˜¯å‘Šè¯‰ä»–
		- ä½ è¿åäº†usernameçš„uniqueçº¦æŸ
		- ç”¨æˆ·ä¼šè¿·ç³ŠğŸ˜¯
- è¿™å°±éœ€è¦åœ¨æ’å…¥ä¹‹å‰è¿›è¡Œåˆ¤æ–­
	- è¿™ä¸ªç”¨æˆ·åæ˜¯å¦å·²ç»å­˜åœ¨

### å…ˆåˆ¤æ–­

```java
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.io.IOException;
import java.io.PrintWriter;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
public class InsertServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    @Override
    public void doPost(HttpServletRequest request,
                      HttpServletResponse response)
        throws IOException, ServletException
    {
		request.setCharacterEncoding("utf-8");
        response.setContentType("text/html");
        response.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();
		Connection c = null;
		Statement stmt = null;
		try {
			Class.forName("org.postgresql.Driver");
			c = DriverManager.getConnection(
					"jdbc:postgresql://localhost:5432/oeasy", "postgres",
					"oeasy@pg");
			c.setAutoCommit(false);
			out.println("db connection is ok!!<br/>");
			stmt = c.createStatement();
			String Username = request.getParameter("username");
			String Password = request.getParameter("password");
			ResultSet rs = stmt.executeQuery("select * from login where Username='"+Username+"'");
			if(rs.next()){
				stmt.close();
				c.close();
				response.sendRedirect("http://localhost:8080/oeasy/error?msg=usernameExists");
			}
			String sql = "insert into login(username,password) values('"+Username+"','"+Password+"');";
			System.out.print("sql======================" + sql);
			stmt.executeUpdate(sql);
			stmt.close();
			c.commit();
			c.close();

		} catch (Exception e) {
			e.printStackTrace();
			System.err.println(e.getClass().getName() + ": " + e.getMessage());
		}
		response.sendRedirect("http://localhost:8080/oeasy/select");
    }
}
```

- è¦æ³¨æ„è·³è½¬ä¹‹å‰ç»“æŸ
	- statement
	- connection

### æ–°å»ºerroræ˜ å°„

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20211130-1638243308689)

### ErrorServlet.java

```java
import java.io.IOException;
import java.io.PrintWriter;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
public class ErrorServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    public void doGet(HttpServletRequest request,
                      HttpServletResponse response)
        throws IOException, ServletException{
		request.setCharacterEncoding("utf-8");
        response.setContentType("text/html");
        response.setCharacterEncoding("utf-8");
        PrintWriter out = response.getWriter();
        out.println("<!DOCTYPE html><html><body>");
		String ErrorMessage = request.getParameter("msg");
        if(ErrorMessage.equals("usernameExists")){
		    out.print("è¿™ä¸ªç”¨æˆ·åå·²ç»å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©!");
        }
        out.print("<a href="./prepareInsert.html">è¿”å›æ³¨å†Œé¡µé¢</a>");
        out.println("</body></html>");
    }
}
```

- å¦‚æœæ˜¯å¤åˆ¶ä»£ç çš„è¯
- æ³¨æ„åŒå¼•å·çš„è½¬ä¹‰é—®é¢˜

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651027426734)

### æŠ¥é”™ä¿¡æ¯

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20211130-1638243754158)

- ä»çº¢è‰²çš„è¿çº¿å¯çŸ¥
- æŠ¥é”™ä¿¡æ¯ç¡®å®æ˜¯
	- ç”¨getçš„æ–¹å¼ä¼ é€’åˆ°/error
	- /error è·¯ç”±åˆ° ErrorServlet.class
	- è¿›è¡Œå¤„ç†
- è¿™æ ·é‡å¤ç”¨æˆ·åæ³¨å†Œçš„é—®é¢˜å°±è§£å†³äº†
- å¯æ˜¯å¦‚æœæ•°æ®åº“æœåŠ¡æ ¹æœ¬å°±æ²¡å¼€ä¼šå¦‚ä½•å‘¢ï¼Ÿ

### æŠ¥é”™

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651060517475)

- å¦‚æœè¿æ¥çš„æ—¶å€™å°±å‡ºäº†é—®é¢˜
- ç›´æ¥å°±è·³åˆ°59è¡Œ
- å¯¼è‡´ç”»é¢ä¸€ç‰‡å¤§ç™½

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651060630648)

- ç”¨æˆ·ä¼šå¾ˆè¿·èŒ«
- å“ªæ€•å°±æ˜¯å‘Šè¯‰ä»–å‡ºé”™äº†å‘¢?!

### å¤„ç† 

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651060714753)

```
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.io.IOException;
import java.io.PrintWriter;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
public class InsertServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
	@Override
	public void doPost(HttpServletRequest request,
			HttpServletResponse response)
		throws IOException, ServletException{
		request.setCharacterEncoding("utf-8");
		response.setContentType("text/html");
		response.setCharacterEncoding("UTF-8");
		PrintWriter out = response.getWriter();
		Connection c = null;
		Statement stmt = null;
		try {
			Class.forName("org.postgresql.Driver");
			c = DriverManager.getConnection(
					"jdbc:postgresql://localhost:5432/oeasy", "postgres",
					"oeasy@pg");
			c.setAutoCommit(false);
			out.println("db connection is ok!!<br/>");
			stmt = c.createStatement();
			String Username = request.getParameter("username");
			String Password = request.getParameter("password");
			if(Username!=null&&Username.length()>10){
				System.out.println("=====yes username too loog");
				stmt.close();
				c.commit();
				c.close();
				response.sendRedirect("http://localhost:8080/oeasy/error?msg=usernameTooLong");
			}
			else{
				ResultSet rs = stmt.executeQuery("select * from login where Username='"+Username+"'");
				if(rs.next()){
					stmt.close();
					c.commit();
					c.close();
					response.sendRedirect("http://localhost:8080/oeasy/error?msg=usernameExists");
				}
				else{
					String sql = "insert into login(username,password) values('"+Username+"','"+Password+"');";
					System.out.print("sql======================" + sql);
					stmt.executeUpdate(sql);
					stmt.close();
					c.commit();
					c.close();
					response.sendRedirect("http://localhost:8080/oeasy/select");
				}

			}
		} catch (Exception e) {
			e.printStackTrace();
			System.err.println(e.getClass().getName() + ": " + e.getMessage());
            response.sendRedirect("http://localhost:8080/oeasy/error?msg=err");
		}
	}
}
```

- ç„¶åä¹Ÿerrorä¸­ä¹Ÿéœ€è¦å¤„ç†åˆ†æ”¯
### error

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651060948083)

- åˆ†æ”¯å¤„ç†åº”è¯¥æ²¡æœ‰é—®é¢˜

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651061162560)

- ä½†å¦‚æœ/erroræ ¹æœ¬æ¥ä¸åˆ°msgå‚æ•°ä¼šå¦‚ä½•ï¼Ÿ

### å¤§ç™½

- åˆæ˜¯å¤§ç™½
- è¿™ç¨‹åºå†™å¾—éƒ½å¿«èµ¶ä¸Šè¯—ä»™äº†...

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651063695243)

- åœ¨logs/catalina.outä¸­æ‰¾åˆ°åŸå› 

### ç»†åŒ–

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20220427-1651063878436)

- åœ¨æœ€å‰é¢å…ˆåˆ¤æ–­ErrorMessageæ˜¯å¦ä¸ºç©º
- å¦‚æœä¸ºç©ºçš„è¯å°±ç›´æ¥å†™å‡ºé”™äº†
- null==ErrorMessageæ›´å¥½
	- å› ä¸ºErrorMessage==nullå¯èƒ½å‡ºé”™
		- æœ‰å¯èƒ½è¯¯å†™æˆErrorMessage=null
	- null==ErrorMessageä¸€ç›®äº†ç„¶ 
		- ä¸å‡ºé—®é¢˜

### ErrorServlet.java
```
import java.io.IOException;
import java.io.PrintWriter;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
public class ErrorServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    public void doGet(HttpServletRequest request,
                      HttpServletResponse response)
        throws IOException, ServletException{
        request.setCharacterEncoding("utf-8");
        response.setContentType("text/html");
        response.setCharacterEncoding("utf-8");
        PrintWriter out = response.getWriter();
        out.println("<!DOCTYPE html><html><body>");
        String ErrorMessage = request.getParameter("msg");
        System.out.print("==="+ErrorMessage+"==");
        if(null==ErrorMessage){
            out.print("å‡ºé”™äº†");
        }
        else if(ErrorMessage.equals("usernameExists")){
            out.print("è¿™ä¸ªç”¨æˆ·åå·²ç»å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©!");
        }
        else if(ErrorMessage.equals("usernameTooLong")){
            out.print("ç”¨æˆ·åå¤ªé•¿äº†,ä¸èƒ½è¶…è¿‡åä¸ªå­—ç¬¦");
        }
        else if(ErrorMessage.equals("err")){
            out.print("å‡ºé”™äº†");
        }
        out.print("<a href=\"./prepareInsert.html\">è¿”å›æ³¨å†Œé¡µé¢</a>");
        out.println("</body></html>");
    }
}
```

### æ€»ç»“
- è¿™æ¬¡è§£å†³äº†é‡å¤ç”¨æˆ·åçš„é—®é¢˜
- ä½†æ˜¯è¿˜æ˜¯å¯èƒ½æœ‰é—®é¢˜çš„
- æ¯”å¦‚æ•°æ®åº“ä¸­æˆ‘ä»¬çš„æ•°æ®å­˜å‚¨å®½åº¦æ˜¯30

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/uid1190679-20211130-1638244120503)

- å¦‚æœæäº¤çš„å­—ç¬¦ä¸²é•¿åº¦å¤§äº30ï¼Œä¼šå¦‚ä½•å‘¢?ğŸ¤”
- ä¸‹æ¬¡å†è¯´ï¼ğŸ‘‹